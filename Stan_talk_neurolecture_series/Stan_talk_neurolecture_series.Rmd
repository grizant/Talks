---
title: "Reasoning with Uncertainty the Bayesian way"
subtitle: "with examples in Cognitive Modeling in R and Stan"
author: "AG Schissler"
date: "2/09/2018"
output: beamer_presentation
toc: true
bibliography: library.bib
header-includes:
- \usepackage{graphicx}
- \usepackage{pdfpages}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
suppressWarnings(library(rstan))
```

# Motivation

## The problem
- Reproducibility crisis (what to cite?)
- confusion
- Impact of Statistical methods for research workers @Fisher1925

## ASA on p-values from @Wasserstein2016
1. P-values can indicate how incompatible the data are with a specified statistical model.
2. P-values do not measure the probability that the studied hypothesis is true, or the probability that the data were produced by random chance alone.
3. Scientific conclusions and business or policy decisions should not be based only on whether a p-value passes a specific threshold.
4. Proper inference requires full reporting and transparency
5. A p-value, or statistical significance, does not measure the size of an effect or the importance of a result.
6. By itself, a p-value does not provide a good measure of evidence regarding a model or hypothesis.

## Statistical Rethinking @McElreath2016

\includegraphics[page=4,width=0.8\paperwidth]{Lecture01.pdf}

## flowchart

\includegraphics[height=0.9\paperheight, keepaspectratio]{stats_flow_chart_v2014.pdf}

## Lindley 1986 quote?

# Bayes 101

## General principles

## Prediction

## Sequential updating

## MCMC

# Case Study I: Inferring IQ using Gaussians

## I.1. Research question and data 

We seek to estimate the IQ of a set of people. There are only three subjects and each take three IQ tests. The data are displayed below:

```{r IQ_data}
x <- matrix(c(90, 95, 100, 105, 110, 115, 150, 155, 160), 
            nrow=3, ncol=3, byrow=T)
rownames(x) <- paste0("Subject", 1:3)
colnames(x) <- paste0("Measurement", 1:3)
kable(x)
```

## I.2. Graphical model

## I.3. Stan model Code

```{r IQ_stan_model, echo = TRUE}
model <- "
// Repeated Measures of IQ
data { 
  int<lower=1> n;
  int<lower=1> m;
  matrix[n, m] x;
}
parameters {
  vector<lower=0,upper=300>[n] mu;
  real<lower=0,upper=100> sigma;
} 
model {
  // Data Come From Gaussians With Different Means
  // But Common Standard Deviation
  for (i in 1:n)
    for (j in 1:m)  
      x[i,j] ~ normal(mu[i], sigma);
}"
```

## I.3  Code

```{r IQ_presample, echo = TRUE, cache = T}

n <- nrow(x) # number of people
m <- ncol(x) # number of repeated measurements

data <- list(x=x, n=n, m=m) # to be passed on to Stan
myinits <- list(
  list(mu=rep(100, n), sigma=1))

# parameters to be monitored: 
parameters <- c("mu", "sigma")
```

## I.3  Code
```{r IQ_sampling, echo = TRUE, cache = T, results = "hide"}

# The following command calls Stan with specific options.
# For a detailed description type "?rstan".
samples <- stan(model_code=model,   
                data=data, 
                init=myinits,  # If not specified, gives random inits
                pars=parameters,
                iter=2000, 
                chains=1, 
                thin=1,
                # warmup = 100,  # Stands for burn-in; Default = iter/2
                # seed = 123  # Setting seed; Default is random seed
                )
# Now the values for the monitored parameters are in the "samples" object, 
# ready for inspection.
```

## I.4. Output and discussion
```{r IQ_output1, echo = FALSE}
kable(print(samples))
```
## I.5. Output and discussion
```{r IQ_output2, echo = FALSE, cache = TRUE}
stan_dens(samples)
```

## I.5. Under a community of priors?

# Case Study II: Hierachical signal detection

## II.1. Research question and data 

Subjects are presented with stimuli that are either signal or noise and asked to make a decision whether the trial features signal or noise. The results of the experiment for the $i^{the}$ subject can be tabulated in a simple $2 \times 2$ table:

	| |Signal|Noise|
	|---|---|---|
	|Yes response| Hit | False alarm|
	|No response| Miss | Correct rejection|
 

## II.1. Research question and data 

```{r SDT_data}
source("~/OneDrive - University of Nevada, Reno/Research/RStan/example-models/Bayesian_Cognitive_Modeling/CaseStudies/SignalDetection/heit_rotello.RData") #loads the data
names(std_i) <- c("hits", "false alarms", "misses", "correct rejections")
kable(head(std_i))
```

## II.2. Graphical model

## II.3. Stan model Code

```{r SDT_stan_model, echo = TRUE}
model <- "
// Hierarchical Signal Detection Theory
data { 
  int<lower=1> k;
  int<lower=0> h[k];
  int<lower=0> f[k];
  int<lower=0> s;
  int<lower=0> n;
}
parameters {
  vector[k] d;
  vector[k] c;
  real muc;
  real mud;
  real<lower=0> lambdac;
  real<lower=0> lambdad;
} 

transformed parameters {
  real<lower=0,upper=1> thetah[k];
  real<lower=0,upper=1> thetaf[k];
  real<lower=0> sigmac;
  real<lower=0> sigmad;
  
  sigmac = inv_sqrt(lambdac);
  sigmad = inv_sqrt(lambdad);
  
  // Reparameterization Using Equal-Variance Gaussian SDT
  for(i in 1:k) {
    thetah[i] = Phi(d[i] / 2 - c[i]);
    thetaf[i] = Phi(-d[i] / 2 - c[i]);
  }
}
model {
  // Priors 
  muc ~ normal(0, inv_sqrt(.001));
  mud ~ normal(0, inv_sqrt(.001));
  lambdac ~ gamma(.001, .001);
  lambdad ~ gamma(.001, .001);
  
  // Discriminability and Bias
  c ~ normal(muc, sigmac);
  d ~ normal(mud, sigmad);
  // Observed counts
  h ~ binomial(s, thetah);
  f ~ binomial(n, thetaf);
}"
```

## II.3  Code

```{r SDT_presample, echo = TRUE, cache = T}
niter   <- 10000
nburnin <- 1000
```

## II.3  Code
```{r SDT_sampling, echo = TRUE, cache = T, results = "hide"}

for (dataset in 1:2) {  #analyze both conditions

  if (dataset == 1)
    data <- std_i # the induction data
  if (dataset == 2)
    data <- std_d # the deduction data
  
  h <- data[, 1]
  f <- data[, 2]
  MI <- data[, 3]
  CR <- data[, 4]
  s <- h + MI
  n <- f + CR
  s <- s[1]; n <- n[1] #Each subject gets same number of signal and noise trials 
  k <- nrow(data) 

  data <- list(h=h, f=f, s=s, n=n, k=k) # To be passed on to Stan

  myinits <- list(
    list(d=rep(0, k), c=rep(0, k), mud=0, muc=0, lambdad=1, lambdac=1)) 

  # Parameters to be monitored
  parameters <- c("mud", "muc", "sigmad", "sigmac")
  
  if (dataset == 1) {
    # The following command calls Stan with specific options.
    # For a detailed description type "?rstan".
    isamples <- stan(model_code=model,   
                     data=data, 
                     init=myinits,  # If not specified, gives random inits
                     pars=parameters,
                     iter=niter, 
                     chains=1, 
                     thin=1,
                     warmup=nburnin,  # Stands for burn-in; Default = iter/2
                     # seed=123  # Setting seed; Default is random seed
    )
  }
  if (dataset == 2) {
    # The following command calls Stan with specific options.
    # For a detailed description type "?rstan".
    dsamples <- stan(fit=isamples,   
                     data=data, 
                     init=myinits,  # If not specified, gives random inits
                     pars=parameters,
                     iter=niter, 
                     chains=1, 
                     thin=1,
                     warmup=nburnin,  # Stands for burn-in; Default = iter/2
                     # seed=123  # Setting seed; Default is random seed
    )
  }
}
# Now the values for the monitored parameters are in the "isamples" and 
# "dsamples "objects, ready for inspection.

```

## II.4. Output and discussion
```{r SDT_output1, echo = FALSE, cache = TRUE}
keepi <- 1000
keep <- sample(niter, keepi)

imud <- extract(isamples)$mud
imuc <- extract(isamples)$muc
d.imuc <- density(imuc)

dmud <- extract(dsamples)$mud
dmuc <- extract(dsamples)$muc
d.dmuc <- density(dmuc)
```

## II.5. Output and discussion
```{r SDT_output2, echo = FALSE}
#####Figure 11.5 & 11.6

layout(matrix(c(1,2,3,0),2,2,byrow=T), width=c(2/3, 1/3), heights=c(2/3,1/3))
#layout.show()

par(mar=c(2,2,1,0))
plot(imud[keep],imuc[keep], xlab="", ylab="", axes=F,xlim=c(-1,6), ylim=c(-3,3))
points(dmud[keep],dmuc[keep], col="grey")
box(lty=1)

par(mar=c(2,1,1,4))
plot(d.imuc$y, d.imuc$x, xlim=rev(c(0,2.5)),type='l', axes=F, xlab="", ylab="",
     ylim=c(-3,3))
lines(d.dmuc$y, d.dmuc$x, col="grey")
axis(4)
mtext(expression(paste(mu, "c")), side=4,line=2.3, cex=1.3)
box(lty=1)

par(mar=c(6,2,0,0))
plot(density(imud),zero.line=F ,main="", ylab="", xlab="", cex.lab=1.3, axes=F,
     xlim=c(-1,6),ylim=c(0,1))
lines(density(dmud), col="grey")
axis(1, at=c(-1, 0, 1, 2, 3, 4, 5, 6))
mtext(expression(paste(mu, "d")), side=1.2,line=2, cex=1.3)
box(lty=1)

```

## I.5. Under a community of priors?

# Case Study III: Psychophysical

## Extension to contamination

insert graphical model

# Conclusion and references

## Take home points
- Bayesian modeling is natural and flexible
- Tools exist to aeou
- collaboration opportunities

## Software used

## References 
